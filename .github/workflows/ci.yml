name: Build, Push and Deploy to Local VM (Self-Hosted Runner)

on:
  push:
    branches: [main]

jobs:
  build-push-deploy:
    runs-on: self-hosted

    steps:
      # ===============================
      # CHECKOUT
      # ===============================
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: List files (debug)
        shell: powershell
        run: |
          Write-Host "Current directory:"
          Get-Location
          Write-Host "Files in repo:"
          Get-ChildItem

      # ===============================
      # LOGIN DOCKER HUB
      # ===============================
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ===============================
      # BUILD IMAGE (POWERSHELL FIXED)
      # ===============================
      - name: Build Docker image
        shell: powershell
        run: |
          $USERNAME = "${{ secrets.DOCKERHUB_USERNAME }}"
          $IMAGE_LATEST = "$USERNAME/mon-site-flask:latest"
          $IMAGE_SHA = "$USERNAME/mon-site-flask:${{ github.sha }}"

          Write-Host "Building image: $IMAGE_LATEST"

          # Build en précisant le Dockerfile
          docker build -f Dockerfile -t $IMAGE_LATEST .

          if ($LASTEXITCODE -ne 0) {
              Write-Host "❌ Build failed"
              exit 1
          }

          docker tag $IMAGE_LATEST $IMAGE_SHA

      # ===============================
      # PUSH IMAGE
      # ===============================
      - name: Push Docker image
        shell: powershell
        run: |
          $USERNAME = "${{ secrets.DOCKERHUB_USERNAME }}"
          $IMAGE_LATEST = "$USERNAME/mon-site-flask:latest"
          $IMAGE_SHA = "$USERNAME/mon-site-flask:${{ github.sha }}"

          Write-Host "Pushing images..."

          docker push $IMAGE_LATEST
          docker push $IMAGE_SHA

      # ===============================
      # DEPLOY LOCAL WINDOWS
      # ===============================
      - name: Deploy locally on Windows
        shell: powershell
        run: |
          Write-Host "===== DEPLOYMENT START ====="

          $DOCKERHUB_USERNAME = "${{ secrets.DOCKERHUB_USERNAME }}"
          $IMAGE_NAME = "mon-site-flask"
          $TAG = "latest"
          $FULL_IMAGE = "$DOCKERHUB_USERNAME/$IMAGE_NAME`:$TAG"
          $CONTAINER_NAME = "flask-app"

          Write-Host "Image à déployer: $FULL_IMAGE"

          # Pull latest image
          docker pull $FULL_IMAGE

          # Vérifier si le conteneur existe
          $EXISTING_CONTAINER = docker ps -a --filter "name=$CONTAINER_NAME" --format "{{.Names}}"

          if ($EXISTING_CONTAINER -eq $CONTAINER_NAME) {
              Write-Host "Ancien conteneur trouvé, suppression..."
              docker stop $CONTAINER_NAME
              docker rm $CONTAINER_NAME
          } else {
              Write-Host "Aucun ancien conteneur trouvé"
          }

          # Démarrer nouveau conteneur
          Write-Host "Démarrage du nouveau conteneur..."

          docker run -d `
            --name $CONTAINER_NAME `
            --restart unless-stopped `
            -p 5000:5000 `
            -e SECRET_KEY="${{ secrets.APP_SECRET_KEY }}" `
            -e FLASK_ENV=production `
            $FULL_IMAGE

          if ($LASTEXITCODE -ne 0) {
              Write-Host "❌ Erreur lors du démarrage"
              docker logs $CONTAINER_NAME
              exit 1
          }

          Start-Sleep -Seconds 5

          $RUNNING = docker ps --filter "name=$CONTAINER_NAME" --filter "status=running" --format "{{.Names}}"

          if ($RUNNING -eq $CONTAINER_NAME) {
              Write-Host "✅ Conteneur démarré avec succès"
              Write-Host "Application disponible sur http://localhost:5000"
              docker logs $CONTAINER_NAME
          } else {
              Write-Host "❌ Échec du démarrage"
              docker ps -a --filter "name=$CONTAINER_NAME"
              docker logs $CONTAINER_NAME
              exit 1
          }

          Write-Host "===== DEPLOYMENT END ====="